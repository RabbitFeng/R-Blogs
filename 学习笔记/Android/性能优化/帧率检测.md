# 基于工具的排查

## 快速排查：GPU 呈现模式分析 (开发者选项)

这是检测 RecyclerView 性能最直观的方法，无需代码：

- **操作**：在“开发者选项”中找到 **“GPU 呈现模式分析”** (Profile GPU Rendering)，选择“在屏幕上显示为条形图”。
- **观察**：滑动 RecyclerView 时，屏幕会实时出现直方图。
  - **绿线**：代表 16.6ms（60fps 基准）。
  - **蓝色部分**：代表 **Layout 和 Measure** 的耗时。如果蓝色条很高，说明 RecyclerView 的 Item 布局太复杂或 `onBindViewHolder` 逻辑过重。 

## 精准分析：Android Studio Profiler (系统追踪)

如果你需要找出具体是哪一帧掉帧以及原因，使用内置的 **Profiler**：

- **步骤**：打开 Profiler -> 点击 CPU 视图 -> 选择 **System Trace** 并开始录制。
- **定位**：录制一段 RecyclerView 滑动过程。在结果中寻找 **"Janky frames"**（掉帧），这些帧会以红色标出。
- **细节**：由于 RecyclerView 内置了 Trace 标记，你可以看到具体的 `RV OnLayout`、`RV OnBind` 或 `RV CreateView` 耗时。如果 `CreateView` 过长，说明 XML 布局解析太慢；如果 `Bind` 过长，说明数据绑定逻辑有性能瓶颈。 

# 生产环境的使用

如果你想在应用运行期间通过代码收集掉帧数据，推荐使用官方的 **JankStats** 库：

- **原理**：它可以追踪每一帧的状态，并提供关于丢帧（Jank）的详细统计数据。

```
package com.example;

import android.util.Log;
import android.view.Choreographer;

import java.util.concurrent.TimeUnit;

/**
 * @author dongzf
 * @since 2026/1/20
 */
public class FrameDetector {
    private static final String TAG = "FrameDetector";

    private FrameDetector() {
    }

    public static FrameDetector getInstance() {
        return SingletonHolder.INSTANCE;
    }

    private static class SingletonHolder {
        private static final FrameDetector INSTANCE = new FrameDetector();
    }

    private volatile boolean hasInit = false;

    private long lastFrameTimeNanos = 0;

    public void init() {
        if (hasInit) {
            return;
        }
        hasInit = true;

        Choreographer.getInstance().postFrameCallback(new Choreographer.FrameCallback() {
            @Override
            public void doFrame(long frameTimeNanos) {
                if (lastFrameTimeNanos != 0) {
                    long frameIntervalNanos = frameTimeNanos - lastFrameTimeNanos;
                    Log.d(TAG, "doFrame: " + TimeUnit.NANOSECONDS.toMillis(frameIntervalNanos));
                }
                lastFrameTimeNanos = frameTimeNanos;
                Choreographer.getInstance().postFrameCallback
                        (this);
            }
        });
    }
}
```

